// var datapdsAL = '{"level":"ALd","CASESIZEFYC" : {    "MTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    },    "QTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    },    "YTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    }  },"CASESIZEANP" : {    "MTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    },    "QTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    },    "YTD" : {      "dataArray_1" : "5",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "0"    }  },  "ACTIVEAGENTS" : {    "MTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "3",      "dataArray_4" : "1"    },    "QTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "3",      "dataArray_4" : "1"    },    "YTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "3",      "dataArray_4" : "1"    }  },  "CASESIZEANP" : {    "MTD" : {      "dataArray_1" : "0",      "dataArray_6" : "",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "QTD" : {      "dataArray_1" : "0",      "dataArray_6" : "",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "YTD" : {      "dataArray_1" : "0",      "dataArray_6" : "",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    }  },  "RECRUIT" : {    "MTD" : {      "dataArray_1" : "0",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "QTD" : {      "dataArray_1" : "0",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "YTD" : {      "dataArray_1" : "0",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    }  },  "ANP" : {    "MTD" : {      "dataArray_1" : "508378",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "513929",      "dataArray_4" : "5551"    },    "QTD" : {      "dataArray_1" : "508378",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "513929",      "dataArray_4" : "5551"    },    "YTD" : {      "dataArray_1" : "508378",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "513929",      "dataArray_4" : "5551"    }  },  "CASESIZEFYP" : {    "MTD" : {      "dataArray_1" : "20059",      "dataArray_6" : "",      "dataArray_3" : "96996",      "dataArray_5" : "426781",      "dataArray_2" : "37128",      "dataArray_7" : "18504",      "dataArray_4" : "2433"    },    "QTD" : {      "dataArray_1" : "101931",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "103781",      "dataArray_4" : "1850"    },    "YTD" : {      "dataArray_1" : "101931",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "103781",      "dataArray_4" : "1850"    }  },  "ACTIVENEW" : {    "MTD" : {      "dataArray_1" : "0",      "dataArray_6" : "",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "QTD" : {      "dataArray_1" : "0",      "dataArray_6" : "",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    },    "YTD" : {      "dataArray_1" : "0",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "0",      "dataArray_4" : "0"    }  },  "FYC" : {    "MTD" : {      "dataArray_1" : "109173",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "2380",      "dataArray_2" : "0",      "dataArray_7" : "112552",      "dataArray_4" : "999"    },    "QTD" : {      "dataArray_1" : "109173",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "2380",      "dataArray_2" : "0",      "dataArray_7" : "112552",      "dataArray_4" : "999"    },    "YTD" : {      "dataArray_1" : "109173",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "2380",      "dataArray_2" : "0",      "dataArray_7" : "112552",      "dataArray_4" : "999"    }  },  "FYP" : {    "MTD" : {      "dataArray_1" : "509656",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "59960",      "dataArray_2" : "0",      "dataArray_7" : "575167",      "dataArray_4" : "5551"    },    "QTD" : {      "dataArray_1" : "509656",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "59960",      "dataArray_2" : "0",      "dataArray_7" : "575167",      "dataArray_4" : "5551"    },    "YTD" : {      "dataArray_1" : "509656",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "59960",      "dataArray_2" : "0",      "dataArray_7" : "575167",      "dataArray_4" : "5551"    }  },  "CASES" : {    "MTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0.98",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "3"    },    "QTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "3"    },    "YTD" : {      "dataArray_1" : "2",      "dataArray_6" : "0.00",      "dataArray_3" : "0",      "dataArray_5" : "0",      "dataArray_2" : "0",      "dataArray_7" : "5",      "dataArray_4" : "3"    }  }}';
// BP.getProductData(datapdsAL);

define(['jquery','tppl','clickStyles','product','language'],function($,t,cs,p,language){
  return {
    BP_STA:1,
    productData:null,
    KPIId:null,
    KPIName:null,
    productId:null,

    getProductData:function(data){
      this.productData = data;
    },
    updateProduct:function(){
      this.KPIId = "FYC";
      this.KPIName = "FYC";
      this.productId = "MTD";
      var data = $.parseJSON(this.productData);
      var head = '';

      if(data.level == "AG"){
        head = '<li class="pa"><a href="#FYC" data-toggle="tab">FYC</a><i class="selected"></i></li>'+
        		 '<li class="pa"><a href="#FYP" data-toggle="tab">FYP</a><i></i></li>'+
        		 '<li class="pa"><a href="#ANP" data-toggle="tab">ANP</a><i></i></li>'+
        		 '<li class="pa"><a href="#Cases" data-toggle="tab">Case</a><i></i></li>'+
        		 '<li class="pa2"><a href="#Case Size FYC" data-toggle="tab">Case Size FYC</a><i></i></li>'+
        		 '<li class="pa2"><a href="#Case Size FYP" data-toggle="tab">Case Size FYP</a><i></i></li>';
      }else if(data.level == "AL"){
        head = '<li class="pa"><a href="#FYC" data-toggle="tab">FYC</a><i class="selected"></i></li>'+
         		 '<li class="pa"><a href="#FYP" data-toggle="tab">FYP</a><i></i></li>'+
         		 '<li class="pa"><a href="#ANP" data-toggle="tab">ANP</a><i></i></li>'+
         		 // '<li class="pa1" style="width:auto;"><a href="#New Recruits" data-toggle="tab">New Recruits</a><i></i></li>'+
         		 // '<li class="pa1" style="width:auto;"><a href="#Active New Agents" data-toggle="tab">Active New Agents</a><i></i></li>'+
         		 // '<li class="pa1" style="width:auto;"><a href="#Active Agents" data-toggle="tab">Avg.Active Agent</a><i></i></li>'+
         		 '<li class="pa2" style="width:auto;"><a href="#Case Size FYP" data-toggle="tab">Case Size FYP</a><i></i></li>';
      }else{
        head = '<li class="pa"><a href="#FYC" data-toggle="tab">FYC</a><i class="selected"></i></li>'+
             '<li class="pa"><a href="#FYP" data-toggle="tab">FYP</a><i></i></li>'+
             '<li class="pa"><a href="#ANP" data-toggle="tab">ANP</a><i></i></li>'+
             '<li class="pa"><a href="#CASE" data-toggle="tab">Case</a><i></i></li>';
             // '<li class="pa2" style="width:auto;"><a href="#Case Size ANP" data-toggle="tab">Case Size ANP</a><i></i></li>';
      }

      if($("#tag").val()!="popup"){
         $("#top_btn").append(head);
      }

      //first add to html
      this.add2Html(data.FYC.MTD);

      //每次进入的时候默认点击第一个KPI
      $("#top_btn li a:eq(0)").click();

      var content = this;
      //listen on top bar click
      $("#B-title a").click(function(){
        try{
          $('#tmpl-product').remove();
          $('#view').empty();

          $("#B-title i").removeClass('selected');
          $(this).next('i').addClass('selected');
          cs.changeTopBtn("B-title","rgb(199,0,54)","#554344");
          cs.changeTopBtn("sub_btn","rgb(165,162,152)","#554344");

          var titleName =  $(this).text();
          if(titleName == "Case"){
            titleName = "Cases";
          } else if(titleName == "Avg.Active Agent") {
            titleName = "Active Agents";
          } else if(titleName == "Case/Avg.Active Agent") {
            titleName = "Cases";
          }else if(titleName == "New Recruits") {
            titleName = "RECRUIT";
          }else if(titleName == "Active New Agents") {
            titleName = "ACTIVENEW";
          }

          content.KPIId =titleName.toUpperCase().replace(/ /g,"");
          content.KPIName = $(this).text();

          if($(this).text() == "Case/Avg.Active Agent" || $(this).text() == "Case"){
            data[content.KPIId]["MTD"].status = "1";
            data[content.KPIId]["QTD"].status = "1";
            data[content.KPIId]["YTD"].status = "1";
          }
          try{
            content.add2Html(data[content.KPIId]["MTD"]);
          }catch(e){
          }

          //if FA change subtitle
          content.changeSubTitle(data);
          //change the title when click kpi
          $("#F-MTD th :eq(1)").text($(this).text());
        }catch(e){
          content.add2Html();
        }
			});
           
			//listen on second bar click
			$("#sub_btn tr td").click(function(){
				$('#tmpl-product').remove();
				var productId;
				if($(this).index() == 0){
					productId = "MTD";
				}else if($(this).index() == 1){
					productId = "QTD";
				}else{
					productId = "YTD";
				}
				content.productId = productId;
				content.add2Html(data[content.KPIId][productId]);
				//change the title when click kpi
				$("#F-MTD th :eq(1)").text(content.KPIName);
        
        //if FA change subtitle
        content.changeSubTitle(data);
			});
			
			cs.changeTopBtn("B-title","rgb(199,0,54)","#554344");
			cs.changeTopBtn("sub_btn","rgb(165,162,152)","#554344");
			
      
      //if FA change subtitle
      this.changeSubTitle(data);
    },
    add2Html: function(param){
      //create chart
      createCircleChart(param);
      //create table
      this.changeKPI(param);
      //change language to html
      language.changeLanguage();
    },
    changeKPI:function(param){
      var render = tppl($("#product-tmpl").html());
      var dataPer = this.getPercentage(param);
      var FYCData = this.changeTitle(param);
      var html = render(FYCData);
      $('.container #content').append(html);
    },
    changeTitle:function(data){
      var title = ["Ordinary Life", "Single Premium", "ILP", "PA", "CSG", "Credit Life"];
      var titleANP = ["Ordinary Life", "Single Premium(10%)", "ILP(RP+10%SP)", "PA", "CSG", "Credit Life"];
      //change table title
      var ret = data;
      if(this.KPIId == "ANP" || this.KPIId == "FYP" || this.KPIId == "CASESIZEFYP" || this.KPIId == "CASESIZEANP"){
      	ret.title = titleANP;
      }else{
      	ret.title = title;
      }
      return ret;
    },
    //if FA,change subtitle QTD(join FA) YTD(join FA)
    changeSubTitle:function(data) {
      if(data.level == "FA"){
        $("#QTD").text(Global.language[BP.languageType].B_QTD_FA);
        $("#YTD").text(Global.language[BP.languageType].B_YTD_FA);
      } 
    },
    getPercentage:function(param){
    	var total = 0;

      if(BP.valueToInt(param["dataArray_1"]) > 0){
      	total += BP.valueToInt(param["dataArray_1"]);
      }
      if(BP.valueToInt(param["dataArray_2"]) > 0){
      	total += BP.valueToInt(param["dataArray_2"]);
      }
      if(BP.valueToInt(param["dataArray_3"]) > 0){
      	total += BP.valueToInt(param["dataArray_3"]);
      }
      if(BP.valueToInt(param["dataArray_4"]) > 0){
      	total += BP.valueToInt(param["dataArray_4"]);
      }
      if(BP.valueToInt(param["dataArray_5"]) > 0){
      	total += BP.valueToInt(param["dataArray_5"]);
      }
      if(BP.valueToInt(param["dataArray_6"]) > 0){
      	total += BP.valueToInt(param["dataArray_6"]);
      }

      var per = [];
      if(BP.valueToInt(param["dataArray_1"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_1"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_2"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_2"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_3"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_3"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_4"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_4"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_5"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_5"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_6"]) > 0){
      	per.push(this.percentage(BP.valueToInt(param["dataArray_6"]),total));
      }else{
      	per.push("0%");
      }

      if(BP.valueToInt(param["dataArray_1"])<=0 &&BP.valueToInt(param["dataArray_2"])<=0 &&BP.valueToInt(param["dataArray_3"])<=0 &&BP.valueToInt(param["dataArray_4"])<=0 &&BP.valueToInt(param["dataArray_5"])<=0 &&BP.valueToInt(param["dataArray_6"])<=0){
      	per.push("0%");
      }else{
      	per.push("100%");
      }
      param.per = per;

      return param;
    },
    percentage:function(num,den){
      if(!num || !den || den == 0 || num <0 || den <0){
        return '0%';
      }
      var data = (num/den*100).toFixed(1);
      return data + "%";
    }
   }
});